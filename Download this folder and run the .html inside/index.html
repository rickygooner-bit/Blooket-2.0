<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BlockBuster Ultimate</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- LOAD THE QUESTIONS FROM EXTERNAL FILE -->
    <script src="questions.js"></script>

    <!-- Custom Config & Styles -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4aa8ff',
                        secondary: '#2c3e50',
                        accent: '#a255ff',
                        gold: '#fbbf24',
                        goldDark: '#b45309',
                        success: '#22c55e',
                        danger: '#ef4444',
                        surface: '#ffffff',
                    },
                    fontFamily: {
                        sans: ['Nunito', 'sans-serif'],
                    },
                    animation: {
                        'bounce-short': 'bounce 0.5s infinite',
                        'pulse-fast': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                        'pop-up': 'popUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards',
                        'shake': 'shake 0.5s cubic-bezier(.36,.07,.19,.97) both',
                        'flame': 'flame 1s infinite alternate',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        popUp: {
                            '0%': { opacity: '0', transform: 'scale(0.5) translateY(20px)' },
                            '100%': { opacity: '1', transform: 'scale(1) translateY(0)' },
                        },
                        shake: {
                            '10%, 90%': { transform: 'translate3d(-1px, 0, 0)' },
                            '20%, 80%': { transform: 'translate3d(2px, 0, 0)' },
                            '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0)' },
                            '40%, 60%': { transform: 'translate3d(4px, 0, 0)' }
                        },
                        flame: {
                            '0%': { transform: 'scale(1)' },
                            '100%': { transform: 'scale(1.1)' }
                        }
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;900&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Nunito', sans-serif;
            background-color: #f3f4f6;
            overflow-x: hidden;
            user-select: none;
        }
        .blook-shadow {
            box-shadow: 0px 5px 0px rgba(0,0,0,0.2);
            transition: all 0.1s;
        }
        .blook-shadow:active {
            transform: translateY(3px);
            box-shadow: 0px 2px 0px rgba(0,0,0,0.2);
        }
        .game-container {
            max-width: 1100px;
            margin: 0 auto;
        }
        
        /* Custom Chest Styling */
        .chest-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
            cursor: pointer;
            transition: transform 0.1s;
        }
        .chest-wrapper:hover {
            transform: scale(1.05);
        }
        .chest-body {
            position: absolute;
            bottom: 0;
            left: 10%;
            width: 80%;
            height: 55%;
            background: linear-gradient(to bottom, #d97706, #b45309);
            border: 4px solid #78350f;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
            z-index: 10;
        }
        .chest-lid {
            position: absolute;
            bottom: 55%;
            left: 8%;
            width: 84%;
            height: 35%;
            background: linear-gradient(to bottom, #fbbf24, #d97706);
            border: 4px solid #78350f;
            border-radius: 10px 10px 0 0;
            transform-origin: bottom;
            transition: transform 0.4s ease-in-out;
            z-index: 20;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .chest-lock {
            width: 16px;
            height: 24px;
            background: #fbbf24;
            border: 3px solid #78350f;
            border-radius: 4px;
            position: absolute;
            bottom: -12px;
            left: 50%;
            transform: translateX(-50%);
        }
        .is-open .chest-lid {
            transform: rotateX(110deg) translateY(-10px);
        }
        .is-open .chest-body {
            filter: brightness(0.8);
        }

        /* Blook Avatar Styles */
        .blook-avatar {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            color: white;
            font-size: 1.5rem;
            border-bottom: 4px solid rgba(0,0,0,0.2);
            transition: transform 0.1s;
        }
        .blook-avatar:active {
            border-bottom-width: 0px;
            transform: translateY(4px);
        }
        
        /* Glitch Text for Crypto */
        .glich-text {
            position: relative;
        }
        .glich-text::before, .glich-text::after {
            content: attr(data-text);
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        (function() { // IIFE for scope protection

        const { useState, useEffect, useRef, useCallback } = React;

        // --- UTILS ---
        const shuffleArray = (array) => {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        };

        const prepareGameData = (questions) => {
            return questions.map(q => {
                const correctText = q.a[q.correct];
                const shuffledAnswers = shuffleArray(q.a);
                const newCorrectIndex = shuffledAnswers.indexOf(correctText);
                return { ...q, a: shuffledAnswers, correct: newCorrectIndex, originalCorrect: correctText };
            }).sort(() => Math.random() - 0.5);
        };

        const PREMADE_SETS = window.BLOCKBUSTER_DATA || [];

        const BAD_WORDS = ["badword", "swear", "curse", "stupid", "dumb", "hate", "ugly", "nasty", "hell", "damn", "ass", "bitch", "shit", "fuck", "cunt", "dick", "piss", "bastard", "crap", "whore", "slut", "cock", "pussy", "tit", "boob", "fag", "nigger", "nigga", "chink", "kike", "dyke", "retard", "spastic", "kill", "die", "murder", "death", "suicide", "anal", "rectum", "penis", "vagina", "sex"]; 

        // --- BLOOK DEFINITIONS ---
        const BLOOKS = [
            { id: 'wizard', icon: 'fa-hat-wizard', color: 'bg-purple-600', cost: 10, rate: 5 }, // Rate for Factory Mode
            { id: 'dragon', icon: 'fa-dragon', color: 'bg-red-600', cost: 150, rate: 25 },
            { id: 'ghost', icon: 'fa-ghost', color: 'bg-gray-400', cost: 50, rate: 10 },
            { id: 'robot', icon: 'fa-robot', color: 'bg-blue-500', cost: 80, rate: 15 },
            { id: 'alien', icon: 'fa-user-astronaut', color: 'bg-green-500', cost: 120, rate: 20 },
            { id: 'ninja', icon: 'fa-user-ninja', color: 'bg-slate-800', cost: 200, rate: 35 },
            { id: 'king', icon: 'fa-crown', color: 'bg-yellow-500', cost: 500, rate: 100 },
            { id: 'cat', icon: 'fa-cat', color: 'bg-orange-400', cost: 20, rate: 4 },
            { id: 'dog', icon: 'fa-dog', color: 'bg-amber-700', cost: 20, rate: 4 },
            { id: 'fish', icon: 'fa-fish', color: 'bg-cyan-400', cost: 15, rate: 3 },
            { id: 'spider', icon: 'fa-spider', color: 'bg-slate-900', cost: 30, rate: 6 },
            { id: 'hippo', icon: 'fa-hippo', color: 'bg-fuchsia-600', cost: 60, rate: 12 },
            { id: 'frog', icon: 'fa-frog', color: 'bg-green-600', cost: 25, rate: 5 },
            { id: 'bird', icon: 'fa-crow', color: 'bg-sky-600', cost: 40, rate: 8 },
            { id: 'horse', icon: 'fa-horse', color: 'bg-amber-800', cost: 45, rate: 9 },
            { id: 'skull', icon: 'fa-skull', color: 'bg-stone-500', cost: 100, rate: 18 },
            { id: 'bomb', icon: 'fa-bomb', color: 'bg-red-800', cost: 90, rate: 16 },
            { id: 'gem', icon: 'fa-gem', color: 'bg-pink-500', cost: 300, rate: 50 },
            { id: 'bolt', icon: 'fa-bolt', color: 'bg-yellow-400', cost: 250, rate: 40 },
            { id: 'brain', icon: 'fa-brain', color: 'bg-rose-400', cost: 1000, rate: 200 },
        ];

        const BOTS = [
            { id: 1, name: "Dino", blook: BLOOKS[1], gold: 0 },
            { id: 2, name: "Uni", blook: BLOOKS[14], gold: 0 },
            { id: 3, name: "Foxy", blook: BLOOKS[7], gold: 0 }, 
            { id: 4, name: "Alien", blook: BLOOKS[4], gold: 0 },
            { id: 5, name: "Ghost", blook: BLOOKS[2], gold: 0 },
            { id: 6, name: "Robot", blook: BLOOKS[3], gold: 0 },
            { id: 7, name: "Ninja", blook: BLOOKS[5], gold: 0 },
        ];

        // --- VISUAL HELPERS ---
        const getCategoryIcon = (cat) => {
            switch(cat) {
                case 'Math': return <i className="fas fa-calculator text-blue-500"></i>;
                case 'Science': return <i className="fas fa-flask text-green-500"></i>;
                case 'Geography': return <i className="fas fa-globe-americas text-teal-500"></i>;
                case 'History': return <i className="fas fa-landmark text-amber-600"></i>;
                case 'Literature': return <i className="fas fa-book-open text-purple-500"></i>;
                case 'English': return <i className="fas fa-pen-nib text-indigo-500"></i>;
                case 'Tech': return <i className="fas fa-microchip text-slate-600"></i>;
                case 'General': return <i className="fas fa-brain text-pink-500"></i>;
                default: return <i className="fas fa-layer-group text-gray-500"></i>;
            }
        };

        // --- COMPONENTS ---

        const Button = ({ children, onClick, color = "primary", size = "md", className = "", disabled = false }) => {
            const colors = {
                primary: "bg-blue-500 hover:bg-blue-600 border-blue-700 text-white",
                success: "bg-green-500 hover:bg-green-600 border-green-700 text-white",
                warning: "bg-amber-400 hover:bg-amber-500 border-amber-600 text-white text-shadow-sm",
                danger: "bg-red-500 hover:bg-red-600 border-red-700 text-white",
                purple: "bg-purple-500 hover:bg-purple-600 border-purple-700 text-white",
                gray: "bg-slate-200 hover:bg-slate-300 border-slate-400 text-slate-700",
                dark: "bg-slate-700 hover:bg-slate-800 border-slate-900 text-white",
            };
            const sizes = {
                sm: "px-3 py-1 text-sm border-b-2",
                md: "px-6 py-3 text-lg font-bold border-b-4",
                lg: "px-8 py-4 text-2xl font-black border-b-6",
            };
            
            return (
                <button 
                    onClick={onClick}
                    disabled={disabled}
                    className={`${colors[color]} ${sizes[size]} rounded-xl blook-shadow transform transition-transform flex items-center justify-center gap-2 ${className} ${disabled ? 'opacity-50 cursor-not-allowed grayscale' : 'active:translate-y-1 active:border-b-0 active:shadow-none'}`}
                >
                    {children}
                </button>
            );
        };

        const BlookAvatar = ({ blook, size = "md", className = "" }) => {
            const sizes = {
                sm: "w-8 h-8 text-sm",
                md: "w-12 h-12 text-xl",
                lg: "w-20 h-20 text-4xl",
                xl: "w-32 h-32 text-6xl"
            };
            return (
                <div className={`${blook.color} ${sizes[size]} blook-avatar ${className}`}>
                    <i className={`fas ${blook.icon}`}></i>
                </div>
            );
        };

        const ProfileSelector = ({ currentProfile, onSave, onClose }) => {
            const [tempName, setTempName] = useState(currentProfile.name);
            const [tempBlook, setTempBlook] = useState(currentProfile.blook);
            const [error, setError] = useState("");

            const handleSave = () => {
                const nameToCheck = tempName.trim();
                if(!nameToCheck) { setError("Name cannot be empty!"); return; }
                if (!/^[a-zA-Z0-9 ]+$/.test(nameToCheck)) { setError("Standard letters & numbers only"); return; }
                
                let normalized = nameToCheck.toLowerCase().replace(/1/g, 'i').replace(/3/g, 'e').replace(/0/g, 'o').replace(/5/g, 's').replace(/4/g, 'a').replace(/8/g, 'b').replace(/\s/g, '');
                if(BAD_WORDS.some(word => normalized.includes(word))) { setError("Please choose a polite name!"); return; }

                onSave(tempName, tempBlook);
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center p-4 animate-fade-in">
                    <div className="bg-white rounded-3xl p-6 max-w-4xl w-full border-4 border-slate-200 shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                        <div className="flex justify-between items-center mb-4 border-b pb-4">
                            <h2 className="text-3xl font-black text-slate-700">Edit Profile</h2>
                            <Button size="sm" color="danger" onClick={onClose}>Close</Button>
                        </div>
                        <div className="flex-1 overflow-y-auto p-2">
                            <div className="mb-8 text-center">
                                <label className="block text-slate-500 font-bold mb-2 uppercase text-sm tracking-wide">Display Name</label>
                                <div className={`relative max-w-md mx-auto ${error ? 'animate-shake' : ''}`}>
                                    <input value={tempName} onChange={(e) => { setTempName(e.target.value); setError(""); }} maxLength={15} className={`w-full text-center text-3xl font-black p-3 border-4 rounded-xl outline-none transition-colors ${error ? 'border-red-500 bg-red-50 text-red-500' : 'border-slate-300 focus:border-purple-500 text-slate-800'}`} placeholder="Enter Name" />
                                    {error && <div className="text-red-500 font-bold mt-2 text-sm"><i className="fas fa-exclamation-triangle mr-1"></i> {error}</div>}
                                </div>
                            </div>
                            <div className="mb-4">
                                <label className="block text-center text-slate-500 font-bold mb-4 uppercase text-sm tracking-wide">Choose Your Avatar</label>
                                <div className="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 gap-4">
                                    {BLOOKS.map(b => (
                                        <div key={b.id} onClick={() => setTempBlook(b)} className={`cursor-pointer p-2 rounded-xl border-4 transition-all hover:scale-105 ${tempBlook.id === b.id ? 'border-blue-500 bg-blue-50 ring-4 ring-blue-200' : 'border-transparent hover:bg-slate-100'}`}>
                                            <BlookAvatar blook={b} size="lg" className="mx-auto" />
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                        <div className="pt-4 border-t flex justify-center">
                            <Button size="lg" color="success" onClick={handleSave} className="w-full max-w-xs"><i className="fas fa-save mr-2"></i> Save Profile</Button>
                        </div>
                    </div>
                </div>
            );
        };

        const PlayerSelector = ({ bots, onSelect, title }) => (
            <div className="fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center p-4">
                <div className="bg-white rounded-2xl p-6 max-w-3xl w-full animate-fade-in border-4 border-slate-300">
                    <h2 className="text-3xl font-black text-center mb-6 text-slate-700">{title}</h2>
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                        {bots.map(b => (
                            <div key={b.id} onClick={() => onSelect(b)} className="cursor-pointer bg-slate-100 hover:bg-blue-100 hover:border-blue-400 border-2 border-slate-200 rounded-xl p-4 flex flex-col items-center transition-colors">
                                <BlookAvatar blook={b.blook} size="md" className="mb-2" />
                                <div className="font-bold text-lg">{b.name}</div>
                                <div className="text-sm font-bold text-amber-600">
                                    {b.gold} {title.includes("Crypto") ? <i className="fas fa-bolt"></i> : <i className="fas fa-coins"></i>}
                                </div>
                            </div>
                        ))}
                    </div>
                    <div className="mt-6 text-center text-slate-400 text-sm">Select a player to target</div>
                </div>
            </div>
        );

        // --- DASHBOARD ---
        const Dashboard = ({ customSets, onSelectSet, userProfile, onEditProfile }) => {
            const allSets = [...PREMADE_SETS, ...customSets];
            const categories = [...new Set(allSets.map(s => s.category || 'Custom'))];
            const [filter, setFilter] = useState('All');

            if (PREMADE_SETS.length === 0 && customSets.length === 0) {
                return <div className="p-10 text-center"><h1 className="text-3xl font-bold text-red-500">Error Loading Questions</h1></div>
            }

            return (
                <div className="p-6 max-w-6xl mx-auto w-full game-container">
                    <div className="bg-white rounded-2xl border-4 border-slate-200 p-6 mb-8 flex items-center justify-between shadow-sm hover:border-purple-300 transition-colors cursor-pointer group" onClick={onEditProfile}>
                        <div className="flex items-center gap-4">
                            <BlookAvatar blook={userProfile.blook} size="lg" />
                            <div>
                                <div className="text-xs font-extrabold text-purple-500 uppercase tracking-widest mb-1"><i className="fas fa-id-card mr-1"></i> Your Profile</div>
                                <h2 className="text-3xl font-black text-slate-800">{userProfile.name}</h2>
                                <p className="text-slate-400 text-sm font-bold group-hover:text-purple-500 transition-colors">Click to edit</p>
                            </div>
                        </div>
                        <div className="text-purple-500 text-2xl bg-purple-50 p-4 rounded-full"><i className="fas fa-pencil-alt"></i></div>
                    </div>

                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-3xl font-black text-slate-700"><i className="fas fa-gamepad mr-2 text-purple-500"></i> Select a Set</h2>
                        <div className="flex gap-2 overflow-x-auto pb-2">
                            <button onClick={() => setFilter('All')} className={`px-4 py-1 rounded-full text-sm font-bold whitespace-nowrap ${filter === 'All' ? 'bg-slate-800 text-white' : 'bg-slate-200 text-slate-600 hover:bg-slate-300'}`}>All</button>
                            {categories.map(c => (
                                <button key={c} onClick={() => setFilter(c)} className={`px-4 py-1 rounded-full text-sm font-bold whitespace-nowrap ${filter === c ? 'bg-slate-800 text-white' : 'bg-slate-200 text-slate-600 hover:bg-slate-300'}`}>{c}</button>
                            ))}
                        </div>
                    </div>
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {allSets.filter(s => filter === 'All' || (s.category || 'Custom') === filter).map((set, idx) => (
                            <div key={idx} className="bg-white rounded-xl border-4 border-slate-200 overflow-hidden hover:border-purple-400 transition-colors group cursor-pointer flex flex-col shadow-sm" onClick={() => onSelectSet(set)}>
                                <div className="h-24 bg-slate-100 flex items-center justify-center text-4xl border-b-2 border-slate-100 group-hover:bg-purple-50 transition-colors">
                                    {getCategoryIcon(set.category || 'Custom')}
                                </div>
                                <div className="p-4 flex-1 flex flex-col">
                                    <div className="flex justify-between items-start">
                                        <h3 className="font-bold text-lg mb-1 leading-tight">{set.title}</h3>
                                        <span className="text-[10px] font-bold uppercase bg-slate-200 text-slate-600 px-2 py-0.5 rounded">{set.category || 'Custom'}</span>
                                    </div>
                                    <p className="text-slate-500 text-xs mb-4 flex-1 mt-1">{set.desc}</p>
                                    <div className="flex justify-between items-center mt-auto">
                                        <span className="text-xs font-bold text-slate-400"><i className="far fa-question-circle mr-1"></i> {set.questions.length} Qs</span>
                                        <Button size="sm" color="primary">Play</Button>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // --- NEW FACTORY MODE ---
        const FactoryMode = ({ set, timeLimit, userProfile, onExit }) => {
            const [state, setState] = useState('playing');
            const [shuffledQuestions, setShuffledQuestions] = useState([]);
            const [qIndex, setQIndex] = useState(0);
            
            const [cash, setCash] = useState(0);
            const [energy, setEnergy] = useState(100); // 0 to 100
            const [units, setUnits] = useState([]); // { id, count, rate }
            const [history, setHistory] = useState([]);
            
            const [timeLeft, setTimeLeft] = useState(timeLimit * 60);
            const [showShop, setShowShop] = useState(false);

            useEffect(() => { setShuffledQuestions(prepareGameData(set.questions)); }, [set]);

            // Game Loop (1s)
            useEffect(() => {
                if (state === 'finished') return;
                const timer = setInterval(() => {
                    setTimeLeft(prev => {
                        if (prev <= 1) { setState('finished'); clearInterval(timer); return 0; }
                        return prev - 1;
                    });

                    setEnergy(prev => Math.max(0, prev - 2)); // Drain energy

                    // Produce Cash if Energy > 0
                    if(energy > 0) {
                        const production = units.reduce((acc, u) => acc + (u.rate * u.count), 0);
                        setCash(prev => prev + production);
                    }

                }, 1000);
                return () => clearInterval(timer);
            }, [state, units, energy]);

            const handleAnswer = (idx) => {
                const currentQ = shuffledQuestions[qIndex];
                const isCorrect = idx === currentQ.correct;
                
                // Record History
                setHistory(prev => [...prev, { q: currentQ.q, user: currentQ.a[idx], correct: currentQ.originalCorrect, isCorrect }]);

                if(isCorrect) {
                    setEnergy(prev => Math.min(100, prev + 25)); // Refill Energy
                    setCash(prev => prev + 10); // Small cash bonus
                }

                // Next Q immediately for flow
                setQIndex(prev => (prev + 1) % shuffledQuestions.length);
            };

            const buyUnit = (blook) => {
                if(cash >= blook.cost) {
                    setCash(prev => prev - blook.cost);
                    setUnits(prev => {
                        const existing = prev.find(u => u.id === blook.id);
                        if(existing) {
                            return prev.map(u => u.id === blook.id ? {...u, count: u.count + 1} : u);
                        } else {
                            return [...prev, { id: blook.id, blook: blook, count: 1, rate: blook.rate }];
                        }
                    });
                }
            };

            if (state === 'finished') return <GameOver score={cash} type="Cash" onExit={onExit} bots={[]} stats={{}} userProfile={userProfile} history={history} />;

            const income = units.reduce((acc, u) => acc + (u.rate * u.count), 0);

            return (
                <div className="bg-slate-900 min-h-screen flex flex-col font-sans text-white relative overflow-hidden">
                    {/* Header */}
                    <div className="bg-slate-800 p-3 flex justify-between items-center border-b border-slate-700 shadow-lg z-20">
                        <div className="flex items-center gap-4">
                            <button onClick={onExit} className="bg-slate-700 hover:bg-slate-600 px-3 py-1 rounded text-xs font-bold">EXIT</button>
                            <div className="text-xl font-black text-green-400"><i className="fas fa-dollar-sign"></i> {cash.toLocaleString()}</div>
                            <div className="text-sm text-slate-400">+{income}/sec</div>
                        </div>
                        <div className="text-xl font-mono">{Math.floor(timeLeft / 60)}:{(timeLeft % 60).toString().padStart(2, '0')}</div>
                    </div>

                    <div className="flex-1 flex flex-col md:flex-row h-full overflow-hidden">
                        
                        {/* Factory Floor (Left) */}
                        <div className="flex-1 p-6 relative overflow-y-auto">
                            <h2 className="text-2xl font-black mb-4 opacity-50">FACTORY FLOOR</h2>
                            {units.length === 0 && <div className="text-slate-500 text-center mt-20">No workers yet! Answer questions to get energy, then buy units!</div>}
                            <div className="grid grid-cols-4 gap-2">
                                {units.map((u, i) => (
                                    Array.from({length: u.count}).map((_, k) => (
                                        <div key={`${u.id}-${k}`} className="animate-bounce-short">
                                            <BlookAvatar blook={u.blook} size="sm" />
                                        </div>
                                    ))
                                ))}
                            </div>
                            
                            {/* Energy Bar */}
                            <div className="absolute bottom-6 left-6 right-6">
                                <div className="flex justify-between text-xs font-bold mb-1 uppercase tracking-wider">
                                    <span>Energy</span>
                                    <span className={energy < 20 ? "text-red-500 animate-pulse" : "text-blue-400"}>{energy}%</span>
                                </div>
                                <div className="w-full h-4 bg-slate-700 rounded-full overflow-hidden border border-slate-600">
                                    <div className={`h-full transition-all duration-500 ${energy < 20 ? 'bg-red-500' : 'bg-blue-500'}`} style={{width: `${energy}%`}}></div>
                                </div>
                            </div>
                        </div>

                        {/* Interaction Panel (Right) */}
                        <div className="w-full md:w-96 bg-slate-800 border-l border-slate-700 flex flex-col z-30">
                            <div className="flex border-b border-slate-700">
                                <button onClick={() => setShowShop(false)} className={`flex-1 p-3 font-bold ${!showShop ? 'bg-slate-700 text-blue-400' : 'text-slate-400 hover:bg-slate-750'}`}>Questions</button>
                                <button onClick={() => setShowShop(true)} className={`flex-1 p-3 font-bold ${showShop ? 'bg-slate-700 text-yellow-400' : 'text-slate-400 hover:bg-slate-750'}`}>Shop</button>
                            </div>

                            <div className="flex-1 relative">
                                {!showShop ? (
                                    <div className="absolute inset-0 p-4 flex flex-col justify-center">
                                        {shuffledQuestions.length > 0 && (
                                            <div className="animate-fade-in">
                                                <div className="bg-slate-100 text-slate-900 p-4 rounded-xl text-center font-bold mb-4 shadow-lg border-b-4 border-slate-300">
                                                    {shuffledQuestions[qIndex].q}
                                                </div>
                                                <div className="grid grid-cols-1 gap-2">
                                                    {shuffledQuestions[qIndex].a.map((ans, idx) => (
                                                        <button key={idx} onClick={() => handleAnswer(idx)} className="bg-slate-700 hover:bg-slate-600 text-white p-3 rounded-lg font-bold text-sm transition-colors text-left border-b-2 border-slate-900 active:border-b-0 active:translate-y-0.5">
                                                            {ans}
                                                        </button>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                ) : (
                                    <div className="absolute inset-0 overflow-y-auto p-2 space-y-2">
                                        {BLOOKS.slice(0, 10).map(b => (
                                            <div key={b.id} onClick={() => buyUnit(b)} className={`bg-slate-700 p-2 rounded-lg flex items-center justify-between cursor-pointer border-2 ${cash >= b.cost ? 'border-green-500 hover:bg-slate-600' : 'border-red-500 opacity-50'}`}>
                                                <div className="flex items-center gap-3">
                                                    <BlookAvatar blook={b} size="sm" />
                                                    <div>
                                                        <div className="font-bold text-sm">{b.id.toUpperCase()}</div>
                                                        <div className="text-xs text-slate-400">+{b.rate}$/sec</div>
                                                    </div>
                                                </div>
                                                <div className="font-bold text-green-400">${b.cost}</div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- EXISTING GAME MODES UPDATED WITH STREAK & HISTORY ---
        const GoldQuest = ({ set, timeLimit, userProfile, onExit }) => {
            const [state, setState] = useState('playing');
            const [shuffledQuestions, setShuffledQuestions] = useState([]);
            const [qIndex, setQIndex] = useState(0);
            const [gold, setGold] = useState(0);
            const [bots, setBots] = useState(BOTS.map(b => ({...b, gold: Math.floor(Math.random() * 50)})));
            const [timeLeft, setTimeLeft] = useState(timeLimit * 60);
            
            // Streak & History
            const [streak, setStreak] = useState(0);
            const [history, setHistory] = useState([]);

            const [openedChest, setOpenedChest] = useState(null); 
            const [chestContent, setChestContent] = useState(null);
            const [showTargetSelector, setShowTargetSelector] = useState(false);
            const [pendingAction, setPendingAction] = useState(null);

            useEffect(() => { setShuffledQuestions(prepareGameData(set.questions)); }, [set]);

            useEffect(() => {
                if (state === 'finished') return;
                const timer = setInterval(() => {
                    setTimeLeft(prev => {
                        if (prev <= 1) { setState('finished'); clearInterval(timer); return 0; }
                        if (prev % 5 === 0) { setBots(curr => curr.map(b => ({...b, gold: b.gold + Math.floor(Math.random() * 15)}))); }
                        return prev - 1;
                    });
                }, 1000);
                return () => clearInterval(timer);
            }, [state]);

            const handleAnswer = (idx) => {
                const currentQ = shuffledQuestions[qIndex];
                const isCorrect = idx === currentQ.correct;
                
                setHistory(prev => [...prev, { q: currentQ.q, user: currentQ.a[idx], correct: currentQ.originalCorrect, isCorrect }]);

                if(isCorrect) {
                    setStreak(s => s + 1);
                    setState('correct');
                    setTimeout(() => setState('chest'), 800);
                } else {
                    setStreak(0);
                    setState('incorrect');
                    setTimeout(nextQuestion, 1500);
                }
            };

            const nextQuestion = () => {
                setQIndex(prev => (prev + 1) % shuffledQuestions.length);
                setOpenedChest(null);
                setChestContent(null);
                setShowTargetSelector(false);
                setPendingAction(null);
                if(state !== 'finished') setState('playing');
            };

            const openChest = (chestIdx) => {
                if(openedChest !== null) return;
                setOpenedChest(chestIdx);
                
                const r = Math.random();
                let reward = {};
                
                // Multiplier based on Streak
                const multiplier = streak >= 3 ? (streak >= 10 ? 3 : (streak >= 5 ? 2 : 1.5)) : 1;

                if (r < 0.30) { reward = { type: 'gold', val: Math.floor((10 + Math.random()*90) * multiplier) }; }
                else if (r < 0.40) { reward = { type: 'triple', val: 0 }; }
                else if (r < 0.50) { reward = { type: 'double', val: 0 }; }
                else if (r < 0.60) { reward = { type: 'swap', val: 0, action: true }; }
                else if (r < 0.70) { reward = { type: 'steal25', val: 0, action: true }; }
                else if (r < 0.80) { reward = { type: 'steal10', val: 0, action: true }; }
                else if (r < 0.90) { reward = { type: 'lose25', val: 0 }; }
                else { reward = { type: 'lose10', val: 0 }; }

                setChestContent(reward);

                setTimeout(() => {
                    if (reward.type === 'gold') { setGold(g => g + reward.val); setTimeout(nextQuestion, 1500); }
                    else if (reward.type === 'double') { setGold(g => g * 2); setTimeout(nextQuestion, 1500); }
                    else if (reward.type === 'triple') { setGold(g => g * 3); setTimeout(nextQuestion, 1500); }
                    else if (reward.type === 'lose10') { setGold(g => Math.floor(g * 0.9)); setTimeout(nextQuestion, 1500); }
                    else if (reward.type === 'lose25') { setGold(g => Math.floor(g * 0.75)); setTimeout(nextQuestion, 1500); }
                    else if (reward.action) {
                        setPendingAction(reward.type);
                        setTimeout(() => setShowTargetSelector(true), 1000);
                    }
                }, 1000);
            };

            const executeAction = (targetBot) => {
                if (pendingAction === 'swap') {
                    const myGold = gold;
                    setGold(targetBot.gold);
                    setBots(bots.map(b => b.id === targetBot.id ? {...b, gold: myGold} : b));
                } else if (pendingAction === 'steal10') {
                    const stolen = Math.floor(targetBot.gold * 0.10);
                    setGold(gold + stolen);
                    setBots(bots.map(b => b.id === targetBot.id ? {...b, gold: b.gold - stolen} : b));
                } else if (pendingAction === 'steal25') {
                    const stolen = Math.floor(targetBot.gold * 0.25);
                    setGold(gold + stolen);
                    setBots(bots.map(b => b.id === targetBot.id ? {...b, gold: b.gold - stolen} : b));
                }
                setShowTargetSelector(false);
                setTimeout(nextQuestion, 1000);
            };

            if (!shuffledQuestions.length) return <div>Loading...</div>;
            if(state === 'finished') return <GameOver score={gold} type="Gold" onExit={onExit} bots={bots} stats={{}} userProfile={userProfile} history={history} />;

            return (
                <div className="bg-amber-300 min-h-screen flex flex-col font-sans">
                    {showTargetSelector && <PlayerSelector bots={bots} onSelect={executeAction} title={pendingAction === 'swap' ? "Swap Gold!" : "Steal Gold!"} />}

                    <div className="bg-amber-600 p-2 flex justify-between items-center text-white font-black px-4 border-b-4 border-amber-800 shadow-md sticky top-0 z-30">
                        <div className="flex items-center gap-4">
                            <button onClick={onExit} className="bg-amber-800 hover:bg-amber-900 text-white px-3 py-1 rounded-lg text-sm font-bold shadow-sm border-b-2 border-amber-950 active:border-b-0 active:translate-y-0.5">
                                <i className="fas fa-home mr-1"></i> Exit
                            </button>
                            <div className="text-xl flex items-center gap-2"><i className="fas fa-coins text-yellow-300"></i> {gold}</div>
                        </div>
                        <div className="flex items-center gap-4">
                            {streak >= 3 && <div className="text-orange-500 animate-flame text-xl"><i className="fas fa-fire"></i> {streak}</div>}
                            <div className="text-xl font-mono bg-black bg-opacity-20 px-3 rounded">{Math.floor(timeLeft / 60)}:{(timeLeft % 60).toString().padStart(2, '0')}</div>
                        </div>
                    </div>

                    <div className="flex-1 relative flex flex-col justify-center">
                        {state === 'playing' && <QuestionScreen question={shuffledQuestions[qIndex]} onAnswer={handleAnswer} />}
                        
                        {state === 'correct' && (
                            <div className="absolute inset-0 flex items-center justify-center bg-green-500 bg-opacity-90 z-10">
                                <div className="text-center text-white animate-bounce">
                                    <i className="fas fa-check-circle text-8xl mb-4"></i>
                                    <h1 className="text-5xl font-black">CORRECT!</h1>
                                    {streak >= 3 && <div className="text-xl mt-2 font-bold text-yellow-300">STREAK BONUS ACTIVE!</div>}
                                </div>
                            </div>
                        )}

                        {state === 'incorrect' && (
                            <div className="absolute inset-0 flex items-center justify-center bg-red-500 bg-opacity-90 z-10">
                                <div className="text-center text-white">
                                    <i className="fas fa-times-circle text-8xl mb-4"></i>
                                    <h1 className="text-5xl font-black">WRONG!</h1>
                                </div>
                            </div>
                        )}

                        {state === 'chest' && (
                            <div className="absolute inset-0 flex flex-col items-center justify-center bg-slate-800 bg-opacity-90 z-20 p-4">
                                <h2 className="text-3xl text-white font-black mb-10"><i className="fas fa-gem mr-2 text-purple-400"></i> Choose a Chest!</h2>
                                <div className="flex gap-6 md:gap-8 justify-center w-full max-w-4xl flex-wrap">
                                    {[0, 1, 2].map(i => (
                                        <div key={i} onClick={() => openChest(i)} className={`w-32 h-32 md:w-40 md:h-40 chest-wrapper ${openedChest === i ? 'is-open' : ''}`}>
                                            {openedChest === i && chestContent && (
                                                <div className="absolute inset-0 flex flex-col items-center justify-center z-30 animate-pop-up pointer-events-none">
                                                    <div className="text-6xl md:text-7xl mb-2 drop-shadow-lg">
                                                        {chestContent.type === 'gold' && <i className="fas fa-coins text-yellow-400"></i>}
                                                        {chestContent.type === 'triple' && <i className="fas fa-cubes text-purple-400"></i>}
                                                        {chestContent.type === 'double' && <i className="fas fa-cube text-blue-400"></i>}
                                                        {chestContent.type === 'swap' && <i className="fas fa-exchange-alt text-orange-400"></i>}
                                                        {chestContent.type === 'steal10' && <i className="fas fa-mask text-gray-300"></i>}
                                                        {chestContent.type === 'steal25' && <i className="fas fa-bomb text-red-500"></i>}
                                                        {chestContent.type.includes('lose') && <i className="fas fa-chart-line-down text-red-600"></i>}
                                                    </div>
                                                    <div className="font-black text-white text-xl md:text-2xl uppercase drop-shadow-md bg-black bg-opacity-50 px-4 py-1 rounded-full whitespace-nowrap">
                                                        {chestContent.type === 'gold' && `+${chestContent.val} Gold`}
                                                        {chestContent.type === 'triple' && `Triple Gold!`}
                                                        {chestContent.type === 'double' && `Double Gold!`}
                                                        {chestContent.type === 'swap' && `Swap!`}
                                                        {chestContent.type === 'steal10' && `Steal 10%`}
                                                        {chestContent.type === 'steal25' && `Steal 25%`}
                                                        {chestContent.type === 'lose10' && `-10%`}
                                                        {chestContent.type === 'lose25' && `-25%`}
                                                    </div>
                                                </div>
                                            )}
                                            <div className="chest-lid"><div className="chest-lock"></div></div>
                                            <div className="chest-body"></div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                    <div className="h-28 bg-slate-900 text-white p-3 overflow-y-auto text-sm">
                        <div className="flex flex-wrap gap-2 justify-center">
                             <div className="bg-amber-500 px-3 py-1 rounded-full font-bold border-b-2 border-amber-700 shadow-sm flex items-center gap-2">
                                <BlookAvatar blook={userProfile.blook} size="sm" /> 
                                <span>YOU: {gold}</span>
                             </div>
                             {bots.map((b, i) => (
                                 <div key={i} className="bg-slate-700 px-3 py-1 rounded-full text-xs flex items-center gap-1">
                                    <BlookAvatar blook={b.blook} size="sm" />
                                    <span>{b.name}: {b.gold}</span>
                                 </div>
                             ))}
                        </div>
                    </div>
                </div>
            );
        };

        const CryptoHack = ({ set, timeLimit, userProfile, onExit }) => {
            const [state, setState] = useState('playing');
            const [shuffledQuestions, setShuffledQuestions] = useState([]);
            const [qIndex, setQIndex] = useState(0);
            const [crypto, setCrypto] = useState(0);
            const [bots, setBots] = useState(BOTS.map(b => ({...b, gold: Math.floor(Math.random() * 50)})));
            const [passwords, setPasswords] = useState([]);
            const [hacking, setHacking] = useState(false);
            const [hackTarget, setHackTarget] = useState(null); 
            const [timeLeft, setTimeLeft] = useState(timeLimit * 60);
            const [showTargetSelector, setShowTargetSelector] = useState(false);
            const [streak, setStreak] = useState(0);
            const [history, setHistory] = useState([]);

            useEffect(() => { setShuffledQuestions(prepareGameData(set.questions)); generatePasswords(); }, [set]);

            useEffect(() => {
                if (state === 'finished') return;
                const timer = setInterval(() => {
                    setTimeLeft(prev => {
                        if (prev <= 1) { setState('finished'); clearInterval(timer); return 0; }
                        if (prev % 3 === 0) { setBots(curr => curr.map(b => ({...b, gold: b.gold + Math.floor(Math.random() * 10)}))); }
                        return prev - 1;
                    });
                }, 1000);
                return () => clearInterval(timer);
            }, [state]);

            const generatePasswords = () => {
                const chars = ['admin', 'pass', '123', 'user', 'root', 'safe', 'cool', 'hack'];
                let pwds = [];
                for(let i=0; i<3; i++) {
                    pwds.push(chars[Math.floor(Math.random()*chars.length)] + Math.floor(Math.random()*99));
                }
                setPasswords(pwds);
            };

            const handleAnswer = (idx) => {
                const currentQ = shuffledQuestions[qIndex];
                const isCorrect = idx === currentQ.correct;
                
                setHistory(prev => [...prev, { q: currentQ.q, user: currentQ.a[idx], correct: currentQ.originalCorrect, isCorrect }]);

                if(isCorrect) {
                    setStreak(s => s + 1);
                    setState('correct');
                    setTimeout(() => { setState('hack'); generatePasswords(); }, 800);
                } else {
                    setStreak(0);
                    setState('incorrect');
                    setTimeout(nextQuestion, 1500);
                }
            };

            const choosePassword = (pwd) => {
                setHackTarget(pwd);
                setHacking(true);
                setTimeout(() => {
                    setHacking(false);
                    setHackTarget(null);
                    const success = Math.random() > 0.2; 
                    if(success) { setShowTargetSelector(true); } else { nextQuestion(); }
                }, 1500); 
            };

            const stealFromBot = (targetBot) => {
                let multiplier = streak >= 3 ? 1.5 : 1;
                if (streak >= 10) multiplier = 2;

                const amount = Math.floor((10 + Math.floor(Math.random() * 20)) * multiplier); 
                const stolen = Math.min(targetBot.gold, Math.floor((20 + Math.floor(Math.random() * 30)) * multiplier));
                setCrypto(c => c + amount + stolen);
                setBots(bots.map(b => b.id === targetBot.id ? {...b, gold: Math.max(0, b.gold - stolen)} : b));
                setShowTargetSelector(false);
                nextQuestion();
            };

            const nextQuestion = () => {
                setQIndex(prev => (prev + 1) % shuffledQuestions.length);
                setShowTargetSelector(false);
                setState('playing');
            };

            if (!shuffledQuestions.length) return <div>Loading...</div>;
            if(state === 'finished') return <GameOver score={crypto} type="Crypto" onExit={onExit} bots={bots} stats={{}} userProfile={userProfile} history={history} />;

            return (
                <div className="bg-slate-900 min-h-screen flex flex-col font-mono text-sm">
                    {showTargetSelector && <PlayerSelector bots={bots} onSelect={stealFromBot} title="Hack Successful! Steal From Who?" />}

                     <div className="bg-slate-800 p-2 flex justify-between items-center text-green-400 font-bold px-4 border-b border-slate-700 shadow-neon sticky top-0 z-30">
                        <div className="flex items-center gap-4">
                            <button onClick={onExit} className="bg-slate-700 hover:bg-slate-600 text-green-400 border border-green-500 px-3 py-1 rounded text-xs font-bold">
                                <i className="fas fa-arrow-left mr-1"></i> EXIT
                            </button>
                            <div className="text-xl"><i className="fas fa-bolt mr-2"></i> {crypto}</div>
                        </div>
                        <div className="flex items-center gap-4">
                            {streak >= 3 && <div className="text-green-500 animate-pulse text-lg"><i className="fas fa-fire"></i> {streak}</div>}
                            <div className="text-xl text-green-500">{Math.floor(timeLeft / 60)}:{(timeLeft % 60).toString().padStart(2, '0')}</div>
                        </div>
                    </div>

                    <div className="flex-1 relative flex flex-col justify-center">
                        {state === 'playing' && <QuestionScreen question={shuffledQuestions[qIndex]} onAnswer={handleAnswer} />}
                        
                        {(state === 'hack' || hacking) && (
                             <div className="absolute inset-0 flex flex-col items-center justify-center bg-black bg-opacity-95 z-20 text-green-500 p-4">
                                 {hacking ? (
                                     <div className="text-center">
                                        <div className="text-5xl mb-4 animate-pulse"><i className="fas fa-terminal"></i></div>
                                        <h2 className="text-2xl mb-2">BRUTE_FORCING...</h2>
                                        <p className="text-lg text-green-700">Target: {hackTarget}</p>
                                        <div className="w-56 h-3 bg-gray-800 rounded mt-4 overflow-hidden"><div className="h-full bg-green-500 animate-[width_2s_ease-in-out] w-full origin-left"></div></div>
                                     </div>
                                 ) : !showTargetSelector && (
                                     <div className="w-full max-w-xl animate-fade-in">
                                        <h2 className="text-2xl text-center mb-6 glich-text text-green-400">SELECT PASSWORD TO HACK</h2>
                                        <div className="grid grid-cols-3 gap-3">
                                            {passwords.map((p, i) => (
                                                <button key={i} onClick={() => choosePassword(p)} className="p-3 border border-green-500 hover:bg-green-500 hover:text-black transition-colors font-mono text-lg rounded">{p}</button>
                                            ))}
                                        </div>
                                     </div>
                                 )}
                             </div>
                        )}
                    </div>
                </div>
            );
        };

        const GameOver = ({ score, type, onExit, bots, stats, userProfile, history }) => {
            const [showReview, setShowReview] = useState(false);
            
            // Calculate incorrect answers for review
            const mistakes = history ? history.filter(h => !h.isCorrect) : [];
            const correctCount = history ? history.filter(h => h.isCorrect).length : 0;
            const percentage = history && history.length > 0 ? Math.round((correctCount / history.length) * 100) : 0;

            const allScores = [...bots.map(b => b.gold), score].sort((a,b) => b - a);
            const rank = allScores.indexOf(score) + 1;

            if (showReview) {
                return (
                    <div className="min-h-screen bg-slate-800 flex items-center justify-center p-4 font-sans">
                        <div className="bg-white rounded-3xl p-6 max-w-4xl w-full max-h-[90vh] flex flex-col">
                            <div className="flex justify-between items-center mb-4 border-b pb-4">
                                <h2 className="text-3xl font-black text-slate-800">Review Mistakes</h2>
                                <Button size="sm" color="primary" onClick={() => setShowReview(false)}>Back</Button>
                            </div>
                            <div className="flex-1 overflow-y-auto">
                                {mistakes.length === 0 ? (
                                    <div className="text-center p-10 text-xl text-green-600 font-bold">Perfect Game! No mistakes to review! </div>
                                ) : (
                                    mistakes.map((m, i) => (
                                        <div key={i} className="bg-red-50 border-l-4 border-red-500 p-4 mb-4 rounded">
                                            <div className="font-bold text-lg mb-2">{m.q}</div>
                                            <div className="flex gap-4 text-sm">
                                                <div className="text-red-600"><span className="font-bold">You said:</span> {m.user}</div>
                                                <div className="text-green-600"><span className="font-bold">Correct:</span> {m.correct}</div>
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-slate-800 flex items-center justify-center p-4">
                    <div className="bg-white p-6 rounded-3xl text-center max-w-2xl w-full shadow-2xl animate-fade-in flex flex-col md:flex-row gap-8 items-center border-8 border-slate-200">
                        <div className="flex-1 w-full">
                            <h1 className="text-4xl font-black text-slate-800 mb-2">TIME'S UP!</h1>
                            <div className="text-6xl mb-4">{rank === 1 ? '' : rank === 2 ? '' : rank === 3 ? '' : ''}</div>
                            <div className="bg-blue-100 p-4 rounded-2xl mb-4">
                                <div className="text-xs text-blue-600 font-bold uppercase">Total {type}</div>
                                <div className="text-5xl font-black text-blue-800">{score}</div>
                            </div>
                            <div className="text-left bg-slate-50 p-3 rounded-xl text-sm h-32 overflow-y-auto border-2 border-slate-100">
                                {[...bots, {name: userProfile.name, gold: score, blook: userProfile.blook}].sort((a,b) => b.gold - a.gold).map((b, i) => (
                                    <div key={i} className={`flex justify-between border-b py-2 px-2 last:border-0 ${b.name === userProfile.name ? 'bg-amber-100 font-bold' : ''}`}>
                                        <span className="flex items-center gap-2">#{i+1} <BlookAvatar blook={b.blook} size="sm"/> {b.name}</span>
                                        <span className="font-bold">{b.gold}</span>
                                    </div>
                                ))}
                            </div>
                        </div>
                        <div className="flex-1 w-full border-t md:border-t-0 md:border-l border-slate-200 pt-6 md:pt-0 md:pl-6 flex flex-col items-center">
                             <h3 className="text-xl font-black text-slate-700 mb-4">Accuracy</h3>
                             <div className="relative w-32 h-32 mb-4">
                                <svg className="w-full h-full" viewBox="0 0 36 36">
                                    <path className="text-gray-200" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" strokeWidth="3" />
                                    <path className={`${percentage >= 70 ? 'text-green-500' : percentage >= 40 ? 'text-yellow-500' : 'text-red-500'} transition-all duration-1000 ease-out`} strokeDasharray={`${percentage}, 100`} d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" strokeWidth="3" />
                                </svg>
                                <div className="absolute inset-0 flex items-center justify-center flex-col">
                                    <span className="text-3xl font-black text-slate-700">{percentage}%</span>
                                </div>
                             </div>
                             <div className="w-full space-y-2">
                                 <Button onClick={() => setShowReview(true)} className="w-full" size="sm" color="warning">Review Mistakes</Button>
                                 <Button onClick={onExit} className="w-full" size="md">Home</Button>
                             </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        // (Editor and SetupGame remain same as previous version, omitted for brevity but included in logic)
        const Editor = ({ onSave, onCancel }) => {
            const [title, setTitle] = useState("");
            const [desc, setDesc] = useState("");
            const [questions, setQuestions] = useState([]);
            const [qText, setQText] = useState("");
            const [a1, setA1] = useState(""); 
            const [a2, setA2] = useState("");
            const [a3, setA3] = useState("");
            const [a4, setA4] = useState("");

            const addQuestion = () => {
                if(!qText || !a1 || !a2) return alert("Question + 2 answers min");
                const rawAnswers = [a1, a2, a3, a4].filter(a => a);
                setQuestions([...questions, { q: qText, a: rawAnswers, correct: 0 }]);
                setQText(""); setA1(""); setA2(""); setA3(""); setA4("");
            };

            return (
                <div className="p-6 max-w-4xl mx-auto w-full bg-white rounded-2xl border-4 border-slate-200 mt-10">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-3xl font-black text-slate-700">Create Set</h2>
                        <Button color="danger" size="sm" onClick={onCancel}>Cancel</Button>
                    </div>
                    <div className="space-y-4 mb-8">
                        <input className="w-full p-3 text-xl font-bold border-2 border-slate-300 rounded-lg" placeholder="Set Title" value={title} onChange={e => setTitle(e.target.value)} />
                        <input className="w-full p-3 text-md border-2 border-slate-300 rounded-lg" placeholder="Description" value={desc} onChange={e => setDesc(e.target.value)} />
                    </div>
                    <div className="bg-slate-50 p-6 rounded-xl border-2 border-slate-200 mb-8">
                         <input className="w-full p-3 mb-3 border-2 border-slate-300 rounded-lg" placeholder="Question Text" value={qText} onChange={e => setQText(e.target.value)} />
                         <div className="grid grid-cols-2 gap-3">
                            <div className="relative">
                                <input className="w-full p-3 border-2 border-green-400 bg-green-50 rounded-lg" placeholder="Correct Answer" value={a1} onChange={e => setA1(e.target.value)} />
                                <span className="absolute right-3 top-3 text-green-600 text-xs font-bold">CORRECT</span>
                            </div>
                            <input className="p-3 border-2 border-slate-300 rounded-lg" placeholder="Wrong Answer 1" value={a2} onChange={e => setA2(e.target.value)} />
                            <input className="p-3 border-2 border-slate-300 rounded-lg" placeholder="Wrong Answer 2 (Opt)" value={a3} onChange={e => setA3(e.target.value)} />
                            <input className="p-3 border-2 border-slate-300 rounded-lg" placeholder="Wrong Answer 3 (Opt)" value={a4} onChange={e => setA4(e.target.value)} />
                        </div>
                        <div className="mt-2 text-xs text-slate-400 italic text-center">Note: Answers will be shuffled automatically during the game.</div>
                        <Button color="purple" className="mt-4 w-full" onClick={addQuestion}>Add Question</Button>
                    </div>
                    <Button color="success" className="w-full" onClick={() => onSave({ id: Date.now(), title, desc, questions, category: 'Custom' })}>Save Set</Button>
                </div>
            );
        };

        const App = () => {
            const [screen, setScreen] = useState('dashboard'); 
            const [customSets, setCustomSets] = useState([]);
            const [activeSet, setActiveSet] = useState(null);
            const [activeMode, setActiveMode] = useState(null); 
            const [timeLimit, setTimeLimit] = useState(5);
            const [userProfile, setUserProfile] = useState({ name: 'Player', blook: BLOOKS[0] });
            const [showProfileSelector, setShowProfileSelector] = useState(false);

            useEffect(() => {
                const savedSets = localStorage.getItem('blockbuster_sets');
                if(savedSets) { try { setCustomSets(JSON.parse(savedSets)); } catch(e) {} }
                const savedProfile = localStorage.getItem('blockbuster_profile');
                if(savedProfile) { try { setUserProfile(JSON.parse(savedProfile)); } catch(e) {} }
            }, []);

            const saveCustomSet = (newSet) => {
                const updated = [...customSets, newSet];
                setCustomSets(updated);
                localStorage.setItem('blockbuster_sets', JSON.stringify(updated));
                setScreen('dashboard');
            };

            const saveProfile = (name, blook) => {
                const newProfile = { name: name, blook: blook };
                setUserProfile(newProfile);
                localStorage.setItem('blockbuster_profile', JSON.stringify(newProfile));
                setShowProfileSelector(false);
            };

            const Navbar = () => (
                <div className="bg-purple-600 p-4 shadow-lg flex justify-between items-center border-b-4 border-purple-800 sticky top-0 z-50">
                    <div className="flex items-center gap-2 text-white cursor-pointer" onClick={() => { setScreen('dashboard'); setActiveSet(null); }}>
                        <div className="bg-white text-purple-600 p-2 rounded-lg font-black text-xl shadow-md">B</div>
                        <h1 className="text-2xl font-black tracking-wider">BLOCKBUSTER ULT</h1>
                    </div>
                    <div className="flex gap-4 items-center">
                        <div className="cursor-pointer hover:scale-105 transition-transform flex items-center gap-2" onClick={() => setShowProfileSelector(true)}>
                            <div className="text-right hidden sm:block leading-tight">
                                <div className="text-[10px] text-purple-200 font-bold uppercase tracking-wider">Profile</div>
                                <div className="text-white font-bold text-sm">{userProfile.name}</div>
                            </div>
                            <BlookAvatar blook={userProfile.blook} size="sm" className="border-2 border-white shadow-md" />
                        </div>
                        <Button size="sm" color="warning" onClick={() => setScreen('editor')}><i className="fas fa-pen mr-1"></i> Create</Button>
                    </div>
                </div>
            );

            const ModeSelect = ({ onSelect }) => (
                 <div className="flex flex-col items-center justify-center min-h-[80vh] p-4 animate-fade-in">
                    <div className="absolute top-24 left-4">
                        <Button size="sm" color="gray" onClick={() => setScreen('setup')}>Back</Button>
                    </div>
                    <h2 className="text-4xl font-black text-slate-700 mb-10">Choose Mode</h2>
                    <div className="flex flex-wrap gap-6 justify-center">
                        <div onClick={() => onSelect('gold')} className="w-64 bg-yellow-100 rounded-2xl border-b-8 border-yellow-600 cursor-pointer hover:scale-105 transition-transform flex flex-col items-center overflow-hidden shadow-xl">
                            <div className="h-32 w-full bg-yellow-400 flex items-center justify-center text-6xl text-yellow-700"><i className="fas fa-sack-dollar"></i></div>
                            <div className="p-4 text-center"><h3 className="text-xl font-black text-yellow-800 mb-2">Gold Quest</h3><p className="text-xs text-yellow-700 font-bold">Collect chests. Swap gold. Survive.</p></div>
                        </div>
                        <div onClick={() => onSelect('crypto')} className="w-64 bg-purple-100 rounded-2xl border-b-8 border-purple-600 cursor-pointer hover:scale-105 transition-transform flex flex-col items-center overflow-hidden shadow-xl">
                            <div className="h-32 w-full bg-purple-500 flex items-center justify-center text-6xl text-white"><i className="fas fa-user-secret"></i></div>
                            <div className="p-4 text-center"><h3 className="text-xl font-black text-purple-800 mb-2">Crypto Hack</h3><p className="text-xs text-purple-700 font-bold">Guess passwords. Steal Crypto.</p></div>
                        </div>
                        <div onClick={() => onSelect('factory')} className="w-64 bg-slate-700 rounded-2xl border-b-8 border-slate-900 cursor-pointer hover:scale-105 transition-transform flex flex-col items-center overflow-hidden shadow-xl">
                            <div className="h-32 w-full bg-slate-600 flex items-center justify-center text-6xl text-white"><i className="fas fa-industry"></i></div>
                            <div className="p-4 text-center"><h3 className="text-xl font-black text-slate-200 mb-2">Factory</h3><p className="text-xs text-slate-400 font-bold">Answer Qs. Buy Blooks. Print Cash.</p></div>
                        </div>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen bg-gray-100 flex flex-col font-sans text-slate-800">
                    {showProfileSelector && <ProfileSelector currentProfile={userProfile} onSave={saveProfile} onClose={() => setShowProfileSelector(false)} />}
                    {screen !== 'game' && <Navbar />}
                    {screen === 'dashboard' && <Dashboard customSets={customSets} onSelectSet={(s) => { setActiveSet(s); setScreen('setup'); }} userProfile={userProfile} onEditProfile={() => setShowProfileSelector(true)} />}
                    {screen === 'editor' && <Editor onSave={saveCustomSet} onCancel={() => setScreen('dashboard')} />}
                    {screen === 'setup' && <SetupGame set={activeSet} onBack={() => setScreen('dashboard')} onStart={(t) => { setTimeLimit(t); setScreen('mode-select'); }} />}
                    {screen === 'mode-select' && <ModeSelect onSelect={(m) => { setActiveMode(m); setScreen('game'); }} />}
                    {screen === 'game' && activeMode === 'gold' && <GoldQuest set={activeSet} timeLimit={timeLimit} userProfile={userProfile} onExit={() => setScreen('dashboard')} />}
                    {screen === 'game' && activeMode === 'crypto' && <CryptoHack set={activeSet} timeLimit={timeLimit} userProfile={userProfile} onExit={() => setScreen('dashboard')} />}
                    {screen === 'game' && activeMode === 'factory' && <FactoryMode set={activeSet} timeLimit={timeLimit} userProfile={userProfile} onExit={() => setScreen('dashboard')} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

        })(); 
    </script>
</body>
</html>
